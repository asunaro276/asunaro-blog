---
import type { GetStaticPaths } from "astro";
import Layout from "/presentation/layouts/Layout.astro";
import { fetchBlogData } from "/presentation/libs/fetch/fetchBlogData";
import PostPage from "/presentation/components/PostPage/index.astro";
import { parseHeading } from "../../libs/parse/parseHeading";
import "highlight.js/styles/monokai-sublime.min.css";
import { AstroSeo } from "@astrolib/seo";
import { Page as PageDomain } from "/domain/models/page/Page";
import { GetPostData } from "/usecase/getPostData/GetPostData";
import { NewtArticleRepository } from "/infrastructure/newt/ArticleRepository";
import { NewtCategoryRepository } from "/infrastructure/newt/CategoryRepository";
import { NewtTagRepository } from "/infrastructure/newt/TagRepository";
import { NewtYearMonthRepository } from "/infrastructure/newt/YearMonthRepository";

export const getStaticPaths = (async () => {
  const getPostData = new GetPostData(
    new NewtArticleRepository(),
    new NewtCategoryRepository(),
    new NewtTagRepository(),
    new NewtYearMonthRepository(),
  );
  const { articles } = await getPostData.execute({ page: new PageDomain(1) });
  const paths = articles.flatMap(({ articleId }) => ({
    params: {
      id: articleId,
    },
  }));
  return paths;
}) satisfies GetStaticPaths;

const { id } = Astro.params;
const { blogs, categories, tags, yearmonths } = await fetchBlogData({
  ArticleId: id,
});
const headings = parseHeading(blogs[0].body);
---

<AstroSeo
  title={blogs[0].title}
  description={blogs[0].description.replace(/<("[^"]*"|'[^']*'|[^'">])*>/g, "")}
  openGraph={{
    title: blogs[0].title,
    description: blogs[0].description.replace(
      /<("[^"]*"|'[^']*'|[^'">])*>/g,
      "",
    ),
    images: [
      {
        url: blogs[0].coverImage.src,
      },
    ],
  }}
  twitter={{
    cardType: "summary_large_image",
  }}
/>
<Layout>
  <main>
    <PostPage
      blog={blogs[0]}
      headings={headings}
      categories={categories}
      tags={tags}
      yearmonths={yearmonths}
    />
  </main>
</Layout>
